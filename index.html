<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GanaFit | Tu progreso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .card-bg { background: linear-gradient(135deg, #3b82f6, #10b981); }
    .progress-bar { transition: width 2s ease-in-out; }
    .nav-active { color: #3b82f6; font-weight: 600; }
    .modal-bg { background: rgba(0,0,0,0.5); }
  </style>
</head>

<body class="bg-gray-50 text-gray-800">

  <!-- NAVBAR -->
  <nav class="flex justify-between items-center px-6 py-4 bg-white shadow-md sticky top-0 z-50">
    <h1 class="text-2xl font-bold text-blue-600">GanaFit</h1>
    <div class="flex gap-6 text-gray-600">
      <a href="#" id="menuMonedero" class="hover:text-blue-600 font-medium">Monedero</a>
      <a href="#" id="menuPerfil" class="hover:text-blue-600 font-medium">Perfil</a>
    </div>
  </nav>

  <!-- CONTENEDOR PRINCIPAL -->
  <main id="mainContent">
    <!-- SECCI√ìN INICIAL (HOME) -->
    <section id="homeSection">
      <!-- Tarjeta saludo y saldo -->
      <section class="max-w-5xl mx-auto mt-10 px-6">
        <div class="bg-white rounded-2xl shadow p-6 flex flex-col md:flex-row justify-between items-center text-center md:text-left">
          <div>
            <h2 class="text-xl font-bold text-gray-800">Hola, Eduardo üëã</h2>
          </div>
          <div class="flex flex-col md:flex-row items-center gap-10 mt-4 md:mt-0">
            <div>
              <p class="text-sm text-gray-500">Saldo total</p>
              <h3 class="text-2xl font-bold text-green-600">10,25 ‚Ç¨</h3>
            </div>
            <!-- Aqu√≠ ir√° el bot√≥n/estado de apuesta -->
            <div id="apuestaContainer"></div>
          </div>
        </div>
      </section>

      <!-- Previsi√≥n + GanaWallet -->
      <section class="max-w-5xl mx-auto mt-10 px-6 grid md:grid-cols-2 gap-6">
        <!-- Previsi√≥n -->
        <div class="bg-white rounded-2xl shadow p-6">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">Nuestra Previsi√≥n</h3>
          <div class="flex justify-between text-sm text-gray-500 mb-2">
            <p>Inicio: 5 Oct 2025</p>
            <p>Fin: 5 Nov 2025</p>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4 mb-3 relative overflow-hidden">
            <div id="progressBar" class="bg-green-500 h-4 rounded-full progress-bar" style="width: 0%;"></div>
            <span class="absolute right-0 top-[-24px] text-xs text-gray-600">Objetivo: 100 ‚Ç¨</span>
          </div>
          <p class="text-sm text-gray-500 mt-2">
            Progreso actual:
            <span id="progressText" class="font-semibold text-green-600">0 ‚Ç¨ / 100 ‚Ç¨</span>
          </p>
        </div>

        <!-- GanaWallet -->
        <div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center justify-center">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">GanaWallet</h3>
          <div class="card-bg w-full max-w-[320px] h-[200px] rounded-2xl text-white shadow-lg flex flex-col justify-between p-6 relative overflow-hidden">
            <div class="flex justify-between items-start">
              <h4 class="text-xl font-bold tracking-wide">GanaFit</h4>
              <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa" class="h-6 opacity-90">
            </div>
            <div>
              <p class="tracking-widest text-sm">**** **** **** 9241</p>
              <div class="flex justify-between mt-2 text-xs">
                <p>Eduardo</p>
                <p>12/28</p>
              </div>
            </div>
            <div class="absolute bottom-4 right-6 text-2xl font-bold text-white drop-shadow-lg">
              ‚Ç¨10.25
            </div>
          </div>
        </div>
      </section>

      <!-- MAPA HOME -->
      <section class="max-w-6xl mx-auto mt-16 px-6">
        <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">üõçÔ∏è Tiendas afiliadas cerca de ti</h3>
        <p class="text-center text-gray-500 mb-6">Descubre d√≥nde puedes usar tu saldo GanaFit</p>
        <div id="map" class="w-full h-[400px] rounded-2xl shadow-md border border-gray-200"></div>
      </section>
    </section>

    <!-- SECCI√ìN MONEDERO -->
    <section id="walletSection" class="hidden max-w-4xl mx-auto mt-10 px-6">
      <h2 class="text-2xl font-bold mb-6 text-gray-800">Mi monedero</h2>

      <div class="bg-white shadow rounded-2xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-blue-600">GanaFit</h3>
          <h3 class="text-2xl font-bold text-green-600">10,25 ‚Ç¨</h3>
        </div>

        <div class="flex justify-between items-center mb-3">
          <p class="font-semibold text-gray-700">√öltimos movimientos</p>
          <button class="text-blue-600 text-sm hover:underline">Mostrar m√°s</button>
        </div>

        <div class="space-y-2 text-gray-600">
          <div class="flex justify-between items-center">
            <span>Apuesta</span>
            <span class="text-green-600 font-semibold">+10‚Ç¨ ‚¨ÜÔ∏è</span>
          </div>
          <div class="flex justify-between items-center">
            <span>Compra en Intersport</span>
            <span class="text-red-500 font-semibold">-35‚Ç¨ ‚¨áÔ∏è</span>
          </div>
        </div>
      </div>

      <div class="flex justify-center gap-10 mt-8">
        <div class="flex flex-col items-center">
          <button class="bg-blue-600 text-white p-6 rounded-full shadow-lg hover:bg-blue-700 text-2xl">‚Ç¨</button>
          <p class="mt-2 text-sm font-medium">Sacar dinero</p>
        </div>
        <div class="flex flex-col items-center">
          <button class="bg-green-600 text-white p-6 rounded-full shadow-lg hover:bg-green-700 text-2xl">üìò</button>
          <p class="mt-2 text-sm font-medium">Resumen mensual</p>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN PERFIL -->
    <section id="profileSection" class="hidden max-w-4xl mx-auto mt-10 px-6">
      <h2 class="text-3xl font-bold text-gray-800 mb-4">Eduardo Mart√≠nez</h2>
      <p class="text-gray-600 mb-6">Correo electr√≥nico: <span class="font-semibold">eduardo@example.com</span></p>

      <div class="bg-white rounded-2xl shadow p-6 space-y-4">
        <button class="block w-full text-left text-gray-700 hover:text-blue-600">Pol√≠tica de Privacidad</button>
        <button class="block w-full text-left text-gray-700 hover:text-blue-600">Ayuda</button>
        <button id="logoutBtn" class="block w-full text-left text-gray-700 hover:text-blue-600">Cerrar sesi√≥n</button>
        <button class="block w-full text-left text-gray-700 hover:text-blue-600">Sobre nosotros</button>
        <button class="block w-full text-left text-gray-700 hover:text-blue-600">Consentimientos y derechos</button>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="text-center text-gray-500 text-sm py-6 mt-16 bg-gray-100">
    ¬© 2025 GanaFit. Todos los derechos reservados.
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBe1tEnFhRLcu7k_FybzcgrGVxNYNwR1vQ",
      authDomain: "premiosfit.firebaseapp.com",
      projectId: "premiosfit",
      storageBucket: "premiosfit.firebasestorage.app",
      messagingSenderId: "731339914811",
      appId: "1:731339914811:web:1880b3fcef8661a118261e",
      measurementId: "G-JZ0HMJNVCE"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <!-- POPUP DE AUTENTICACI√ìN -->
  <div id="authPopup" class="fixed inset-0 bg-white/90 backdrop-blur-md flex items-center justify-center z-50 p-6">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-md p-8 text-center">
      <h2 class="text-2xl font-bold mb-2 text-gray-800">Bienvenido a GanaFit</h2>
      <p class="text-gray-500 mb-6 text-sm">Inicia sesi√≥n o crea una cuenta para continuar</p>

      <!-- Men√∫ principal -->
      <div id="menuStep" class="flex flex-col gap-3">
        <button id="loginChoiceBtn" class="bg-blue-600 text-white p-3 rounded font-semibold hover:bg-blue-700 transition">
          Iniciar sesi√≥n
        </button>
        <button id="registerChoiceBtn" class="bg-green-600 text-white p-3 rounded font-semibold hover:bg-green-700 transition">
          Registrarse
        </button>
      </div>

      <!-- Paso de inicio de sesi√≥n -->
      <div id="loginStep" class="flex flex-col gap-3 hidden">
        <button id="backToMenu1" class="text-blue-500 text-sm text-left">‚Üê Volver</button>
        <input type="email" id="loginEmail" placeholder="Correo electr√≥nico" class="border p-3 rounded w-full">
        <input type="password" id="loginPassword" placeholder="Contrase√±a" class="border p-3 rounded w-full">
        <button id="loginBtn" class="bg-blue-600 text-white p-3 rounded font-semibold hover:bg-blue-700 transition">
          Iniciar sesi√≥n
        </button>
      </div>

      <!-- Paso de registro -->
      <div id="registerStep" class="flex flex-col gap-3 hidden">
        <button id="backToMenu2" class="text-blue-500 text-sm text-left">‚Üê Volver</button>
        <input type="email" id="registerEmail" placeholder="Correo electr√≥nico" class="border p-3 rounded w-full">
        <input type="password" id="registerPassword" placeholder="Contrase√±a" class="border p-3 rounded w-full">
        <input type="password" id="registerConfirm" placeholder="Confirmar contrase√±a" class="border p-3 rounded w-full">
        <button id="registerBtn" class="bg-green-600 text-white p-3 rounded font-semibold hover:bg-green-700 transition">
          Registrarse
        </button>
      </div>
    </div>
  </div>

  <!-- SCRIPT DE AUTENTICACI√ìN + SPA -->
  <script>
    // Auth popup
    const authPopup = document.getElementById("authPopup");
    const menuStep = document.getElementById("menuStep");
    const loginStep = document.getElementById("loginStep");
    const registerStep = document.getElementById("registerStep");

    const loginChoiceBtn = document.getElementById("loginChoiceBtn");
    const registerChoiceBtn = document.getElementById("registerChoiceBtn");
    const backToMenu1 = document.getElementById("backToMenu1");
    const backToMenu2 = document.getElementById("backToMenu2");

    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginBtn = document.getElementById("loginBtn");

    const registerEmail = document.getElementById("registerEmail");
    const registerPassword = document.getElementById("registerPassword");
    const registerConfirm = document.getElementById("registerConfirm");
    const registerBtn = document.getElementById("registerBtn");

    const logoutBtn = document.getElementById("logoutBtn");

    // SPA sections
    const homeSection = document.getElementById("homeSection");
    const walletSection = document.getElementById("walletSection");
    const profileSection = document.getElementById("profileSection");

    const menuMonedero = document.getElementById("menuMonedero");
    const menuPerfil = document.getElementById("menuPerfil");

    function showSection(section) {
      [homeSection, walletSection, profileSection].forEach(s => s.classList.add("hidden"));
      section.classList.remove("hidden");
    }

    menuMonedero.addEventListener("click", e => {
      e.preventDefault();
      showSection(walletSection);
      menuMonedero.classList.add("nav-active");
      menuPerfil.classList.remove("nav-active");
    });

    menuPerfil.addEventListener("click", e => {
      e.preventDefault();
      showSection(profileSection);
      menuPerfil.classList.add("nav-active");
      menuMonedero.classList.remove("nav-active");
    });

    // Mostrar home por defecto
    showSection(homeSection);

    // Auth listeners
    auth.onAuthStateChanged((user) => {
      authPopup.style.display = user ? "none" : "flex";
      if (user) {
        checkApuesta(); // al loguear, comprobar si tiene apuesta activa
      }
    });

    loginChoiceBtn.onclick = () => {
      menuStep.classList.add("hidden");
      loginStep.classList.remove("hidden");
    };
    registerChoiceBtn.onclick = () => {
      menuStep.classList.add("hidden");
      registerStep.classList.remove("hidden");
    };
    backToMenu1.onclick = backToMenu2.onclick = () => {
      loginStep.classList.add("hidden");
      registerStep.classList.add("hidden");
      menuStep.classList.remove("hidden");
    };

    loginBtn.onclick = async () => {
      const email = loginEmail.value.trim().toLowerCase();
      const password = loginPassword.value.trim();
      if (!email || !password) return alert("Completa ambos campos.");
      try {
        await auth.signInWithEmailAndPassword(email, password);
        authPopup.style.display = "none";
      } catch (error) { alert("Error: " + error.message); }
    };

    registerBtn.onclick = async () => {
      const email = registerEmail.value.trim().toLowerCase();
      const pass = registerPassword.value.trim();
      const conf = registerConfirm.value.trim();
      if (!email || !pass || !conf) return alert("Completa todos los campos.");
      if (pass !== conf) return alert("Las contrase√±as no coinciden.");
      try {
        await auth.createUserWithEmailAndPassword(email, pass);
        authPopup.style.display = "none";
      } catch (error) { alert("Error: " + error.message); }
    };

    if (logoutBtn) logoutBtn.onclick = () => auth.signOut();
  </script>

  <!-- Google Maps para HOME -->
  <script>
    function initMap() {
      const center = { lat: 40.4168, lng: -3.7038 };
      new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: center,
      });
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMKr3Suur4cyDTpJImjC25p5AlLwT1pmA&callback=initMap"></script>

  <!-- ============================= -->
  <!-- POPUP: Apuesta en ti mismo -->
  <!-- ============================= -->
  <div id="apuestaPopup" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-8 relative">
      <button id="closeApuestaPopup" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>

      <!-- Paso 1 -->
      <div id="apuestaStep1">
        <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Apuesta en ti mismo üí™</h2>
        <p class="text-gray-600 mb-6 text-center">Elige tu situaci√≥n actual</p>

        <div class="flex flex-col gap-4">
          <button id="btnYaApuntado" class="bg-blue-600 text-white p-4 rounded-lg font-semibold hover:bg-blue-700">
            üèãÔ∏è‚Äç‚ôÇÔ∏è Ya estoy apuntado a un gimnasio
          </button>
          <button id="btnNoApuntado" class="bg-green-600 text-white p-4 rounded-lg font-semibold hover:bg-green-700">
            üè† No estoy apuntado a ning√∫n gimnasio
          </button>
        </div>
      </div>

      <!-- Paso 2: Mapa + tarjetas -->
      <div id="apuestaStep2" class="hidden">
        <h2 class="text-xl font-bold mb-3 text-gray-800 text-center" id="mapTitle"></h2>
        <div id="gymMap" class="w-full h-64 rounded-xl border shadow mb-4"></div>
        <div id="gymCards" class="grid grid-cols-1 gap-3"></div>
        <div id="selectedGymBox" class="hidden mt-4 bg-blue-50 border border-blue-200 rounded-xl p-3 text-center">
          <p id="selectedGymText" class="font-semibold text-blue-700"></p>
          <button id="continueGymBtn" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Continuar ‚Üí</button>
        </div>
      </div>

      <!-- Paso 3: Datos de apuesta -->
      <div id="apuestaStep3" class="hidden">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Configura tu apuesta</h2>

        <div class="space-y-4">
          <div>
            <label class="block font-medium text-gray-700 mb-1">D√≠as que se compromete a ir:</label>
            <input type="number" id="diasInput" class="w-full border p-2 rounded" placeholder="Ej: 15" min="1">
          </div>

          <p class="text-sm text-gray-500">Contamos con detectores inteligentes en los QR de su gimnasio.</p>

          <div>
            <label class="block font-medium text-gray-700 mb-1">Fecha de inicio de la apuesta:</label>
            <input type="text" id="fechaInicio" class="w-full border p-2 rounded bg-gray-100" readonly>
          </div>

          <div>
            <label class="block font-medium text-gray-700 mb-1">Apuesta (‚Ç¨):</label>
            <input type="number" id="apuestaInput" class="w-full border p-2 rounded" min="10" placeholder="M√≠nimo 10‚Ç¨">
          </div>

          <p class="text-sm text-gray-500">
            Si gana aumentar√° su apuesta un 30% en el primer mes.<br>
            Solo pierde la apuesta si no va al gimnasio <span id="gymNameInfo" class="font-semibold text-blue-600"></span> m√°s de los d√≠as indicados.
          </p>

          <button id="confirmApuestaBtn" class="w-full bg-blue-600 text-white p-3 rounded font-semibold hover:bg-blue-700 mt-4">
            Continuar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- L√ìGICA DE APUESTA + FIRESTORE -->
  <script>
    const apuestaContainer = document.getElementById("apuestaContainer");

    // Popup apuesta (nombres distintos para no chocar con auth popup)
    const apuestaPopupEl = document.getElementById("apuestaPopup");
    const closeApuestaPopup = document.getElementById("closeApuestaPopup");

    const step1 = document.getElementById("apuestaStep1");
    const step2 = document.getElementById("apuestaStep2");
    const step3 = document.getElementById("apuestaStep3");

    const btnYaApuntado = document.getElementById("btnYaApuntado");
    const btnNoApuntado = document.getElementById("btnNoApuntado");
    const mapTitle = document.getElementById("mapTitle");

    const gymMapDiv = document.getElementById("gymMap");
    const gymCardsDiv = document.getElementById("gymCards");
    const selectedGymBox = document.getElementById("selectedGymBox");
    const selectedGymText = document.getElementById("selectedGymText");
    const continueGymBtn = document.getElementById("continueGymBtn");

    const diasInput = document.getElementById("diasInput");
    const fechaInicioInput = document.getElementById("fechaInicio");
    const apuestaInput = document.getElementById("apuestaInput");
    const gymNameInfo = document.getElementById("gymNameInfo");
    const confirmApuestaBtn = document.getElementById("confirmApuestaBtn");

    let selectedGym = null;
    let gymMapInstance = null;

    function openApuestaPopup() {
      apuestaPopupEl.classList.remove("hidden");
      step1.classList.remove("hidden");
      step2.classList.add("hidden");
      step3.classList.add("hidden");
      selectedGym = null;
      selectedGymBox.classList.add("hidden");
      gymCardsDiv.innerHTML = "";
    }

    closeApuestaPopup.onclick = () => apuestaPopupEl.classList.add("hidden");

    function showGymSelection(title) {
      step1.classList.add("hidden");
      step2.classList.remove("hidden");
      mapTitle.textContent = title;
      loadGymMap();
    }

    btnYaApuntado.onclick = () => showGymSelection("Seleccione a qu√© gimnasio est√° apuntado");
    btnNoApuntado.onclick = () => showGymSelection("¬øA qu√© gimnasio le gustar√≠a ir?");

    function loadGymMap() {
      const gyms = [
        { name: "VivaGym Madrid", lat: 40.4185, lng: -3.70256 },
        { name: "Basic-Fit Salamanca", lat: 40.4303, lng: -3.6830 },
        { name: "McFIT Gran V√≠a", lat: 40.4208, lng: -3.7074 },
      ];

      gymMapInstance = new google.maps.Map(gymMapDiv, {
        center: { lat: 40.4168, lng: -3.7038 },
        zoom: 13,
      });

      gyms.forEach(gym => {
        const marker = new google.maps.Marker({
          position: { lat: gym.lat, lng: gym.lng },
          map: gymMapInstance,
          title: gym.name,
        });
        marker.addListener("click", () => {
          renderGymCards(gyms, gym.name);
        });
      });
    }

    function renderGymCards(gyms, selectedName) {
      gymCardsDiv.innerHTML = gyms.map(g =>
        `<button class="border p-3 rounded-lg w-full text-left hover:bg-blue-50 ${g.name === selectedName ? 'border-blue-500' : ''}" onclick="selectGym('${g.name.replace(/'/g, "\\'")}')">
          ${g.name}
        </button>`
      ).join("");
    }

    // Hacemos selectGym global para el onclick inline
    window.selectGym = function(name) {
      selectedGym = name;
      selectedGymBox.classList.remove("hidden");
      selectedGymText.textContent = `Gimnasio seleccionado: ${name}`;
    };

    continueGymBtn.onclick = () => {
      if (!selectedGym) return alert("Seleccione un gimnasio primero.");
      step2.classList.add("hidden");
      step3.classList.remove("hidden");
      gymNameInfo.textContent = selectedGym;
      fechaInicioInput.value = new Date().toLocaleDateString("es-ES");
    };

    confirmApuestaBtn.onclick = async () => {
      const dias = parseInt(diasInput.value);
      const apuesta = parseFloat(apuestaInput.value);
      if (!dias || dias < 1) return alert("Introduzca los d√≠as comprometidos (m√≠nimo 1).");
      if (!apuesta || apuesta < 10) return alert("La apuesta m√≠nima es de 10‚Ç¨.");

      const user = auth.currentUser;
      if (!user) return alert("Debe iniciar sesi√≥n.");

      try {
        await db.collection("apuestas").add({
          userId: user.uid,
          gimnasio: selectedGym,
          diasComprometidos: dias,
          apuesta: apuesta,
          fechaInicio: new Date().toISOString(),
          activa: true
        });
        apuestaPopupEl.classList.add("hidden");
        renderApuestaEnCurso(dias);
      } catch (err) {
        alert("Error al guardar apuesta: " + err.message);
      }
    };

    async function checkApuesta() {
      const user = auth.currentUser;
      if (!user) return;
      try {
        const snapshot = await db.collection("apuestas")
          .where("userId", "==", user.uid)
          .where("activa", "==", true)
          .limit(1)
          .get();

        if (snapshot.empty) {
          apuestaContainer.innerHTML = `
            <button id="btnApuesta" class="bg-blue-600 text-white px-4 py-2 rounded font-semibold hover:bg-blue-700">
              Apuesta en ti mismo
            </button>`;
          document.getElementById("btnApuesta").onclick = openApuestaPopup;
        } else {
          const data = snapshot.docs[0].data();
          renderApuestaEnCurso(data.diasComprometidos);
        }
      } catch (e) {
        console.error(e);
      }
    }

    function renderApuestaEnCurso(dias) {
      apuestaContainer.innerHTML = `
        <div>
          <p class="text-sm text-gray-500">Apuesta en curso</p>
          <h3 class="text-2xl font-bold text-blue-600">0 / ${dias} d√≠as</h3>
        </div>`;
    }

    // Si ya est√° logueado al cargar
    if (auth.currentUser) checkApuesta();
  </script>

</body>
</html>


